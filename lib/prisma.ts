/**
 * Prisma å®¢æˆ¶ç«¯å–®ä¾‹æ¨¡å¡Š
 *
 * ğŸ“‹ æª”æ¡ˆç”¨é€”ï¼š
 * æä¾›å…¨å±€å”¯ä¸€çš„Prismaå®¢æˆ¶ç«¯å¯¦ä¾‹ï¼Œé¿å…é–‹ç™¼ç’°å¢ƒä¸­çš„é€£æ¥æ± è€—ç›¡
 *
 * ğŸ¯ æ ¸å¿ƒåŠŸèƒ½ï¼š
 * 1. å–®ä¾‹æ¨¡å¼ - ç¢ºä¿åªæœ‰ä¸€å€‹PrismaClientå¯¦ä¾‹
 * 2. é–‹ç™¼ç’°å¢ƒå„ªåŒ– - ç†±é‡è¼‰æ™‚é‡ç”¨ç¾æœ‰é€£æ¥
 * 3. ç”Ÿç”¢ç’°å¢ƒæœ€ä½³å¯¦è¸ - æ¯æ¬¡å‰µå»ºæ–°å¯¦ä¾‹
 *
 * ğŸ”— ä½¿ç”¨æ–¹å¼ï¼š
 * ```typescript
 * import { prisma } from '@/lib/prisma'
 *
 * const users = await prisma.user.findMany()
 * ```
 *
 * âš ï¸ æ³¨æ„äº‹é …ï¼š
 * - é–‹ç™¼ç’°å¢ƒï¼šä½¿ç”¨globalè®Šé‡é¿å…ç†±é‡è¼‰æ™‚å‰µå»ºå¤šå€‹å¯¦ä¾‹
 * - ç”Ÿç”¢ç’°å¢ƒï¼šç›´æ¥å‰µå»ºå–®å€‹å¯¦ä¾‹
 * - é€£æ¥æ± ç®¡ç†ï¼šPrismaè‡ªå‹•ç®¡ç†é€£æ¥æ± 
 *
 * ä½œè€…ï¼šClaude Code
 * å‰µå»ºæ™‚é–“ï¼š2025-10-05
 */

import { PrismaClient } from '@prisma/client'

// ========================================================================
// å…¨å±€é¡å‹æ“´å±•ï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰
// ========================================================================

/**
 * æ“´å±•NodeJSå…¨å±€å°è±¡
 * åœ¨é–‹ç™¼ç’°å¢ƒä¸­ç”¨æ–¼å­˜å„²PrismaClientå¯¦ä¾‹
 */
declare global {
  // eslint-disable-next-line no-var
  var prisma: PrismaClient | undefined
}

// ========================================================================
// Prisma å®¢æˆ¶ç«¯å¯¦ä¾‹åŒ–
// ========================================================================

/**
 * å‰µå»ºæˆ–ç²å–Prismaå®¢æˆ¶ç«¯å¯¦ä¾‹
 *
 * å¯¦ç¾é‚è¼¯ï¼š
 * - é–‹ç™¼ç’°å¢ƒï¼šä½¿ç”¨global.prismaé¿å…ç†±é‡è¼‰æ™‚å‰µå»ºå¤šå€‹å¯¦ä¾‹
 * - ç”Ÿç”¢ç’°å¢ƒï¼šç›´æ¥å‰µå»ºæ–°å¯¦ä¾‹
 *
 * é€£æ¥æ± é…ç½®ï¼š
 * - Prismaé»˜èªé€£æ¥æ± å¤§å°ï¼šnum_physical_cpus * 2 + 1
 * - å¯é€šéDATABASE_URLçš„connection_limitåƒæ•¸èª¿æ•´
 */
export const prisma = global.prisma || new PrismaClient({
  log: process.env.NODE_ENV === 'development'
    ? ['query', 'error', 'warn']
    : ['error'],
})

// ========================================================================
// é–‹ç™¼ç’°å¢ƒé…ç½®
// ========================================================================

/**
 * é–‹ç™¼ç’°å¢ƒä¸‹ä¿å­˜å¯¦ä¾‹åˆ°global
 * é¿å…Next.jsç†±é‡è¼‰æ™‚å‰µå»ºéå¤šé€£æ¥
 */
if (process.env.NODE_ENV !== 'production') {
  global.prisma = prisma
}

// ========================================================================
// å„ªé›…é—œé–‰è™•ç†
// ========================================================================

/**
 * é€²ç¨‹é€€å‡ºæ™‚æ–·é–‹æ•¸æ“šåº«é€£æ¥
 * ç¢ºä¿é€£æ¥æ± æ­£ç¢ºæ¸…ç†
 */
if (process.env.NODE_ENV === 'production') {
  process.on('beforeExit', async () => {
    await prisma.$disconnect()
  })
}

/**
 * å°å‡ºé»˜èªå¯¦ä¾‹
 * æ–¹ä¾¿åœ¨å…¶ä»–æ¨¡å¡Šä¸­å°å…¥ä½¿ç”¨
 */
export default prisma
