# Alertmanager Configuration for AI Sales Enablement Platform
# Multi-channel notification with priority-based routing

global:
  resolve_timeout: 5m
  # SMTP é…ç½® (éœ€è¦æ ¹æ“šå¯¦éš›ç’°å¢ƒé…ç½®)
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@ai-sales-platform.com'
  smtp_auth_username: 'your-email@gmail.com'
  smtp_auth_password: 'your-app-password'

# é€šçŸ¥è·¯ç”±è¦å‰‡
route:
  group_by: ['alertname', 'severity', 'component']
  group_wait: 10s
  group_interval: 5m
  repeat_interval: 4h
  receiver: 'default-receiver'

  routes:
    # P1 - Critical: ç«‹å³é€šçŸ¥æ‰€æœ‰æ¸ é“
    - match:
        severity: P1
      receiver: 'critical-alerts'
      continue: false
      group_wait: 10s
      repeat_interval: 30m

    # P2 - High: Email + Slack
    - match:
        severity: P2
      receiver: 'high-priority-alerts'
      continue: false
      group_wait: 30s
      repeat_interval: 2h

    # P3 - Medium: Email only
    - match:
        severity: P3
      receiver: 'medium-priority-alerts'
      continue: false
      group_wait: 5m
      repeat_interval: 6h

    # P4 - Low: æ¯æ—¥æ‘˜è¦
    - match:
        severity: P4
      receiver: 'low-priority-alerts'
      continue: false
      group_wait: 1h
      repeat_interval: 24h

# æŠ‘åˆ¶è¦å‰‡ (é¿å…å‘Šè­¦é¢¨æš´)
inhibit_rules:
  # å¦‚æœ API å®Œå…¨ä¸å¯ç”¨ï¼ŒæŠ‘åˆ¶å…¶ä»– API ç›¸é—œå‘Šè­¦
  - source_match:
      alertname: APICompletelyDown
    target_match:
      component: api
    equal: ['service']

  # å¦‚æœè¨˜æ†¶é«”æ¥µé«˜ï¼ŒæŠ‘åˆ¶è¨˜æ†¶é«”è¼ƒé«˜å‘Šè­¦
  - source_match:
      alertname: CriticalMemoryUsage
    target_match:
      alertname: HighMemoryUsage
    equal: ['instance']

# æ¥æ”¶å™¨é…ç½®
receivers:
  # é»˜èªæ¥æ”¶å™¨
  - name: 'default-receiver'
    email_configs:
      - to: 'dev-team@ai-sales-platform.com'
        headers:
          subject: '[Monitor] {{ .GroupLabels.alertname }}'

  # P1 - Critical: æ‰€æœ‰æ¸ é“ + é›»è©±ï¼ˆå¯é¸ï¼‰
  - name: 'critical-alerts'
    email_configs:
      - to: 'oncall@ai-sales-platform.com'
        headers:
          subject: 'ğŸš¨ [P1-CRITICAL] {{ .GroupLabels.alertname }}'
        html: |
          {{ range .Alerts }}
          <h2>ğŸš¨ CRITICAL ALERT</h2>
          <p><strong>Alert:</strong> {{ .Labels.alertname }}</p>
          <p><strong>Severity:</strong> {{ .Labels.severity }}</p>
          <p><strong>Component:</strong> {{ .Labels.component }}</p>
          <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
          <p><strong>Description:</strong> {{ .Annotations.description }}</p>
          <p><strong>Action Required:</strong> {{ .Annotations.action }}</p>
          <p><strong>Started At:</strong> {{ .StartsAt }}</p>
          {{ end }}

    # Slack é…ç½® (éœ€è¦å‰µå»º Incoming Webhook)
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#alerts-critical'
        title: 'ğŸš¨ P1-CRITICAL: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Action:* {{ .Annotations.action }}
          {{ end }}
        color: 'danger'

    # Microsoft Teams é…ç½® (éœ€è¦å‰µå»º Incoming Webhook)
    webhook_configs:
      - url: 'https://outlook.office.com/webhook/YOUR/TEAMS/WEBHOOK'
        send_resolved: true

  # P2 - High: Email + Slack
  - name: 'high-priority-alerts'
    email_configs:
      - to: 'dev-team@ai-sales-platform.com'
        headers:
          subject: 'âš ï¸ [P2-HIGH] {{ .GroupLabels.alertname }}'
        html: |
          {{ range .Alerts }}
          <h2>âš ï¸ HIGH PRIORITY ALERT</h2>
          <p><strong>Alert:</strong> {{ .Labels.alertname }}</p>
          <p><strong>Component:</strong> {{ .Labels.component }}</p>
          <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
          <p><strong>Description:</strong> {{ .Annotations.description }}</p>
          <p><strong>Action:</strong> {{ .Annotations.action }}</p>
          {{ end }}

    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#alerts-high'
        title: 'âš ï¸ P2-HIGH: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Action:* {{ .Annotations.action }}
          {{ end }}
        color: 'warning'

  # P3 - Medium: Email only
  - name: 'medium-priority-alerts'
    email_configs:
      - to: 'dev-team@ai-sales-platform.com'
        headers:
          subject: 'â„¹ï¸ [P3-MEDIUM] {{ .GroupLabels.alertname }}'
        html: |
          {{ range .Alerts }}
          <h3>â„¹ï¸ MEDIUM PRIORITY ALERT</h3>
          <p><strong>Alert:</strong> {{ .Labels.alertname }}</p>
          <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
          <p><strong>Action:</strong> {{ .Annotations.action }}</p>
          {{ end }}

  # P4 - Low: æ¯æ—¥æ‘˜è¦
  - name: 'low-priority-alerts'
    email_configs:
      - to: 'dev-team@ai-sales-platform.com'
        headers:
          subject: 'ğŸ“Š [P4-LOW] Daily Alert Summary'
        html: |
          <h3>ğŸ“Š Daily Low Priority Alerts Summary</h3>
          {{ range .Alerts }}
          <p><strong>{{ .Labels.alertname }}:</strong> {{ .Annotations.summary }}</p>
          {{ end }}
