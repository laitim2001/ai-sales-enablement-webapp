# Story 2.1: CRM 整合連接器（詳細版）
> **🔴 MVP Priority: Phase 1** - 核心整合，只做單向讀取，簡化同步
> **⏱️ 預估工作量**: 10-12天
> **👥 需要角色**: 後端開發者, 全棧開發者

## User Story
作為一名銷售人員，
我想要系統自動同步我的 Dynamics 365 數據，
以便我不需要在多個系統間手動複製貼上客戶資訊，確保資訊的一致性和即時性。

## 背景說明
CRM 是銷售團隊的核心系統，包含了豐富的客戶資訊和互動歷史。深度整合 CRM 可以大幅提升銷售效率。需要處理大量數據同步、確保資料一致性，並處理可能的 API 限制。

## 技術規格
- **整合方式**：Dynamics 365 Web API (OData v4)
- **認證方式**：Azure AD App Registration
- **同步策略**：事件驅動 + 定期同步混合模式
- **數據映射**：可配置的欄位映射規則
- **錯誤處理**：指數退避重試 + 死信隊列

## 驗收標準

### 1. API 連接器實現：
- OAuth 2.0 認證流程
- Token 自動更新機制
- API 版本相容性檢查
- 連接池管理（最大 10 個並發）
- 請求速率限制遵守（6000/分鐘）
- 斷線重連機制

### 2. 實體同步功能：
- 帳戶（公司）完整資訊同步
- 聯絡人資訊含自定義欄位
- 商機狀態和階段即時更新
- 活動記錄（會議、電話、郵件）
- 相關文檔附件引用
- 自定義實體支援

### 3. 同步機制：
- 即時 webhook 接收變更通知
- 增量同步每 15 分鐘執行
- 全量同步每日凌晨執行
- 同步範圍可配置（按團隊、地區）
- 並行同步提升效率
- 同步狀態持久化

### 4. 數據映射引擎：
- 視覺化欄位映射配置
- 數據類型自動轉換
- 自定義轉換函數支援
- 必填欄位驗證
- 預設值設定
- 映射規則版本控制

### 5. 衝突處理：
- 最後修改時間戳比較
- 三方合併策略（CRM優先/本地優先/手動）
- 衝突通知機制
- 衝突解決審計
- 批量衝突處理介面

### 6. 監控報告：
- 同步儀表板（成功/失敗/待處理）
- 延遲監控（< 5 分鐘為綠燈）
- 數據品質報告
- API 使用量統計
- 異常檢測和告警
- 每日同步摘要郵件

## 技術債務考量
- 準備支援其他 CRM（Salesforce、HubSpot）
- 考慮使用 Change Data Capture 優化
- 大數據量下可能需要分片策略
