# Story 1.2: 核心認證與用戶管理服務（詳細版）
> **🔴 MVP Priority: Phase 1** - 安全基礎，簡化為JWT，暫緩SAML
> **⏱️ 預估工作量**: 10-12天
> **👥 需要角色**: 後端開發者, 安全工程師

## User Story
作為一名銷售人員，
我想要使用公司帳號安全登入系統，
以便存取我的個人化銷售工具並確保數據安全。

## 背景說明
認證系統是整個平台安全性的基石。考慮到目標用戶是企業銷售團隊，必須支援企業級的身份管理系統整合。同時，系統需要支援細粒度的權限控制，因為不同角色（銷售員、經理、管理員）需要存取不同層級的資訊。

## 技術規格
- **認證協議**：OAuth 2.0 + OpenID Connect
- **Token 管理**：JWT with refresh token rotation
- **Session 儲存**：Redis with sliding expiration
- **密碼策略**：符合企業安全標準（複雜度、定期更換）
- **多因素認證**：支援 TOTP (Time-based One-Time Password)

## 驗收標準

### 1. JWT 認證系統實現：
- Access token 有效期 15 分鐘
- Refresh token 有效期 7 天（可配置）
- Token 黑名單機制防止重用
- Token 加密使用 RS256 算法

### 2. 企業身份整合：
- SAML 2.0 支援 Active Directory 整合
- LDAP 連接器用於用戶同步
- 自動用戶創建和屬性映射
- 群組同步用於角色分配

### 3. 角色權限系統：
- 基於 RBAC (Role-Based Access Control) 模型
- 預設角色：銷售員、銷售經理、系統管理員、知識管理員
- 權限可細分到功能和數據層級
- 動態權限載入不需重新登入

### 4. 用戶檔案管理：
- 個人資料維護（姓名、職位、聯絡方式）
- 頭像上傳和儲存
- 偏好設定（語言、時區、通知）
- 活動歷史追蹤

### 5. 安全功能：
- 登入失敗鎖定機制（5 次失敗鎖定 30 分鐘）
- 異常登入檢測（地理位置、設備）
- 強制登出功能
- 密碼重設流程（含 email 驗證）

### 6. 審計日誌：
- 所有認證事件記錄
- 包含 IP、設備、時間戳
- 90 天保留期
- 可匯出用於合規審查

## 技術債務考量
- 預留支援 OAuth 社交登入的擴展點
- 考慮未來支援 biometric 認證
- 確保可以平滑升級到 passwordless 認證
