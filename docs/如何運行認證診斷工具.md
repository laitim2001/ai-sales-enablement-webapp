# 📋 如何運行認證診斷工具 - 用戶指南

> **目的**: 診斷TC-KB-001和TC-PROP-001的401/403權限錯誤
> **所需時間**: 約5-10分鐘
> **難度**: ⭐ 簡單 (複製貼上即可)

---

## 🎯 快速開始 (3步驟)

### 步驟1: 運行診斷腳本 (1分鐘)

打開終端(Terminal)並執行:

```bash
# Windows
cd C:\ai-sales-enablement-webapp
node scripts\diagnose-auth-issues.js

# Mac/Linux
cd /path/to/ai-sales-enablement-webapp
node scripts/diagnose-auth-issues.js
```

你會看到類似這樣的輸出:

```
╔══════════════════════════════════════════════════════════════╗
║  JWT認證問題診斷工具 - 瀏覽器端檢查                          ║
╚══════════════════════════════════════════════════════════════╝

📋 請在瀏覽器開發者工具Console中執行以下代碼：

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🌐 瀏覽器Console診斷代碼:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
(function() {
  console.log('\n🔍 開始JWT認證診斷...\n');
  // ... (一大段診斷代碼)
})();
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 步驟2: 複製瀏覽器診斷代碼 (1分鐘)

1. **選中所有瀏覽器診斷代碼** (從`(function() {`到`})();`)
2. **複製** (Ctrl+C 或 Cmd+C)

### 步驟3: 在瀏覽器Console執行 (2分鐘)

1. **打開瀏覽器** (Chrome, Edge, Firefox都可以)
2. **訪問你的應用** (http://localhost:3000)
3. **打開開發者工具**:
   - Windows/Linux: 按 `F12` 或 `Ctrl+Shift+I`
   - Mac: 按 `Cmd+Option+I`
4. **切換到Console標籤**
5. **貼上並執行代碼** (Ctrl+V 或 Cmd+V,然後按Enter)

---

## 📊 如何理解診斷結果

### ✅ 正常情況 (應該看到這樣)

```
🔍 開始JWT認證診斷...

📦 檢查 localStorage:
┌───────────┬──────┐
│ auth-token│ ✅ 存在│
│ cached-user│ ✅ 存在│
│ tokenLength│ 245  │
└───────────┴──────┘

🍪 檢查 Cookies:
┌───────────┬──────┐
│ auth-token│ ✅ 存在│
└───────────┴──────┘

🔐 解析 JWT Token:
Token內容:
  - userId: 5
  - email: rep@test.com
  - role: SALES_REP
  - 簽發時間 (iat): 2025-10-08 09:30:00
  - 過期時間 (exp): 2025-10-15 09:30:00
  - Token狀態: ✅ 有效
  - 剩餘時間: 167.5 小時

📡 檢查 API 請求配置:
當前頁面URL: http://localhost:3000/dashboard/knowledge/create
API基礎URL: /api

🧪 測試 API 請求 (GET /api/knowledge-base):
  - 狀態碼: 200 OK
  - ✅ API請求成功

════════════════════════════════════════════════════════════
📋 診斷建議:
✅ 未發現明顯問題
════════════════════════════════════════════════════════════
```

### ❌ 異常情況1: Token不存在

```
📦 檢查 localStorage:
┌───────────┬─────────┐
│ auth-token│ ❌ 不存在│
│ cached-user│ ❌ 不存在│
│ tokenLength│ 0      │
└───────────┴─────────┘

════════════════════════════════════════════════════════════
📋 診斷建議:
1. ⚠️ 缺少auth-token，請重新登入
════════════════════════════════════════════════════════════

🔧 常見修復步驟:
1. 清除並重新登入:
   localStorage.clear(); window.location.href = "/login";
```

**原因**: 登入後Token沒有存儲到localStorage
**解決方案**: 重新登入,如果問題持續,需要檢查登入API

### ❌ 異常情況2: Token已過期

```
🔐 解析 JWT Token:
Token內容:
  - userId: 5
  - email: rep@test.com
  - role: SALES_REP
  - 簽發時間 (iat): 2025-09-25 09:30:00
  - 過期時間 (exp): 2025-10-02 09:30:00
  - Token狀態: ❌ 已過期

════════════════════════════════════════════════════════════
📋 診斷建議:
1. ⚠️ Token已過期，請重新登入
════════════════════════════════════════════════════════════
```

**原因**: JWT Token有效期默認7天,已超過有效期
**解決方案**: 清除緩存並重新登入

```javascript
// 在瀏覽器Console執行
localStorage.clear();
window.location.href = "/login";
```

### ❌ 異常情況3: API請求失敗 (權限問題)

```
🧪 測試 API 請求 (GET /api/knowledge-base):
  - 狀態碼: 403 Forbidden
  - 錯誤: Forbidden
  - 訊息: 您沒有執行此操作的權限
  - 錯誤碼: PERMISSION_DENIED

════════════════════════════════════════════════════════════
📋 診斷建議:
1. ⚠️ 權限不足: 角色SALES_REP無["LIST"]權限
════════════════════════════════════════════════════════════
```

**原因**: 用戶角色沒有對應權限
**解決方案**: 需要檢查服務器端配置 (見下一步)

---

## 🖥️ 服務器端診斷 (可選,但推薦)

如果瀏覽器診斷發現權限問題,請運行服務器端診斷:

```bash
# 替換為你的測試用戶email
node scripts/diagnose-auth-issues.js rep@test.com
```

### 正常輸出示例:

```
🔍 開始服務器端診斷 (用戶: rep@test.com)...

👤 檢查用戶記錄:
✅ 用戶存在
┌─────────┬────────────────┐
│ ID      │ 5              │
│ Email   │ rep@test.com   │
│ 角色    │ SALES_REP      │
│ 狀態    │ 啟用           │
│ 最後登入│ 2025-10-08 ... │
└─────────┴────────────────┘

🛡️ 檢查RBAC權限 (知識庫相關):
角色 SALES_REP 的知識庫權限:
  - LIST, CREATE, READ, UPDATE

⚙️ 檢查環境變數:
┌────────────────┬──────────┐
│ JWT_SECRET     │ ✅ 已設置│
│ JWT_EXPIRES_IN │ 7d (預設)│
│ NODE_ENV       │ development│
└────────────────┴──────────┘

🔐 測試Token生成:
✅ Token生成成功
Token長度: 245 字符

Token內容:
  - userId: 5
  - email: rep@test.com
  - role: SALES_REP
  - issuer: ai-sales-platform
  - audience: ai-sales-users

📋 檢查最近的權限拒絕審計日誌:
✅ 沒有權限拒絕記錄

════════════════════════════════════════════════════════════
📋 診斷總結:
✅ 服務器端配置正常，問題可能在前端

建議:
1. 在瀏覽器Console執行前端診斷代碼
2. 檢查瀏覽器localStorage中的auth-token
3. 確認登入後Token是否正確存儲
════════════════════════════════════════════════════════════
```

---

## 🐛 常見問題和解決方案

### Q1: 瀏覽器Console在哪裡?

**答**:
- **Chrome/Edge**: 按`F12`,或右鍵點擊頁面→"檢查"→切換到"Console"標籤
- **Firefox**: 按`F12`,切換到"主控台"標籤
- **Safari**: 先啟用開發選單(偏好設定→進階→顯示「開發」選單),然後按`Cmd+Option+C`

### Q2: 診斷代碼執行後沒有輸出?

**答**:
1. 確認你在正確的Console標籤(不是Elements或Network)
2. 檢查是否有JavaScript錯誤(紅色文字)
3. 重新刷新頁面(F5)後再執行一次

### Q3: API請求測試顯示網路錯誤?

**答**:
1. 確認開發服務器是否正在運行(`npm run dev`)
2. 檢查是否在正確的頁面(http://localhost:3000)
3. 檢查瀏覽器是否阻止了請求(Console中查看錯誤)

### Q4: 服務器端診斷找不到用戶?

**答**:
1. 確認Email拼寫正確
2. 檢查用戶是否確實在數據庫中:
   ```bash
   # 運行Prisma Studio查看數據
   npx prisma studio
   ```
3. 如果用戶不存在,先創建測試用戶

### Q5: Token顯示已過期怎麼辦?

**答**:
```javascript
// 在瀏覽器Console執行以下代碼清除緩存
localStorage.clear();
window.location.href = "/login";

// 然後重新登入
```

---

## 📸 診斷結果提交

### 如何保存診斷結果?

#### 方法1: 截圖 (推薦)

1. 執行診斷代碼後
2. 在瀏覽器Console中右鍵
3. 選擇"保存為..." 或直接截圖(Windows: Win+Shift+S, Mac: Cmd+Shift+4)
4. 保存為`diagnostic-result.png`

#### 方法2: 複製文本

1. 在Console中選擇所有診斷輸出
2. 右鍵→"複製"
3. 貼到文本文件中保存為`diagnostic-result.txt`

### 需要提供的信息

請提供以下診斷結果:

1. ✅ **瀏覽器端診斷結果** (截圖或文本)
2. ✅ **服務器端診斷結果** (如果運行了)
3. ✅ **瀏覽器Network標籤截圖** (顯示失敗的API請求)
   - 打開Network標籤
   - 重新執行失敗的操作(例如創建知識庫文檔)
   - 找到失敗的請求(紅色)
   - 點擊查看詳情並截圖

### 提交方式

將診斷結果提供給開發人員,包括:
- 診斷截圖或文本
- 測試用戶email
- 重現步驟描述

---

## 🎯 預期時間線

| 階段 | 任務 | 時間 | 狀態 |
|------|------|------|------|
| 1 | 運行瀏覽器端診斷 | 3-5分鐘 | ⏳ 待執行 |
| 2 | 運行服務器端診斷 | 1-2分鐘 | ⏳ 待執行 |
| 3 | 提交診斷結果 | 2-3分鐘 | ⏸️ 等待階段1-2 |
| 4 | 開發人員分析 | 10-15分鐘 | ⏸️ 等待階段3 |
| 5 | 實施修復 | 30-60分鐘 | ⏸️ 等待階段4 |
| 6 | 重新測試 | 5-10分鐘 | ⏸️ 等待階段5 |

**總預計時間**: 約1-2小時 (包含修復)

---

## 📚 相關文檔

- `docs/UAT-AUTH-FIX-SUMMARY.md` - 完整技術分析
- `docs/UAT-TEST-ISSUES-ANALYSIS.md` - 所有UAT問題分析
- `scripts/diagnose-auth-issues.js` - 診斷工具源碼

---

**💡 提示**: 如果遇到任何問題或看不懂診斷結果,不用擔心!直接截圖所有輸出並提供給開發人員即可。
