name: ğŸ“‹ Index Sync Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯æ—¥æª¢æŸ¥ (UTC æ™‚é–“ 02:00 = GMT+8 10:00)
    - cron: '0 2 * * *'

jobs:
  index-sync-check:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # éœ€è¦å®Œæ•´æ­·å²ä¾†æª¢æŸ¥æ–‡ä»¶è®Šæ›´

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: |
        npm ci --legacy-peer-deps

    - name: ğŸ” Run index sync check
      id: index_check
      run: |
        echo "æª¢æŸ¥ç´¢å¼•åŒæ­¥ç‹€æ…‹..."
        node scripts/check-index-sync.js > index_check_output.txt 2>&1 || echo "check_failed=true" >> $GITHUB_OUTPUT
        cat index_check_output.txt

    - name: ğŸ“Š Generate coverage report
      run: |
        echo "## ğŸ“‹ ç´¢å¼•åŒæ­¥æª¢æŸ¥å ±å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ¯ æª¢æŸ¥çµæœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f "index-sync-report.json" ]; then
          echo "æª¢æŸ¥è©³ç´°å ±å‘Šå·²ç”Ÿæˆã€‚" >> $GITHUB_STEP_SUMMARY

          # æå–é—œéµæ•¸æ“š
          ISSUES=$(cat index-sync-report.json | jq '.summary.totalIssues // 0')
          HIGH_ISSUES=$(cat index-sync-report.json | jq '.summary.highSeverity // 0')
          SUGGESTIONS=$(cat index-sync-report.json | jq '.summary.suggestions // 0')

          echo "- ğŸ”´ åš´é‡å•é¡Œ: $HIGH_ISSUES" >> $GITHUB_STEP_SUMMARY
          echo "- âš ï¸ ç¸½å•é¡Œæ•¸: $ISSUES" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ’¡ æ”¹é€²å»ºè­°: $SUGGESTIONS" >> $GITHUB_STEP_SUMMARY
        else
          echo "ç„¡æ³•ç”Ÿæˆè©³ç´°å ±å‘Šã€‚" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ğŸ“„ Upload reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: index-sync-reports
        path: |
          index-sync-report.json
          index_check_output.txt
        retention-days: 30

    - name: ğŸ’¬ Comment on PR (if applicable)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          let comment = '## ğŸ“‹ ç´¢å¼•åŒæ­¥æª¢æŸ¥çµæœ\n\n';

          try {
            if (fs.existsSync('index-sync-report.json')) {
              const report = JSON.parse(fs.readFileSync('index-sync-report.json', 'utf8'));

              comment += '### ğŸ“Š æª¢æŸ¥çµ±è¨ˆ\n';
              comment += `- ğŸ”´ åš´é‡å•é¡Œ: ${report.summary?.highSeverity || 0}\n`;
              comment += `- ğŸŸ¡ ä¸­ç­‰å•é¡Œ: ${report.summary?.mediumSeverity || 0}\n`;
              comment += `- ğŸŸ¢ è¼•å¾®å•é¡Œ: ${report.summary?.lowSeverity || 0}\n`;
              comment += `- ğŸ’¡ æ”¹é€²å»ºè­°: ${report.summary?.suggestions || 0}\n\n`;

              if (report.summary?.totalIssues > 0) {
                comment += '### âš ï¸ éœ€è¦æ³¨æ„çš„å•é¡Œ\n';
                comment += 'è«‹æª¢æŸ¥ç´¢å¼•æ–‡ä»¶åŒæ­¥ç‹€æ…‹ï¼Œç¢ºä¿é‡è¦æ–‡ä»¶å·²æ­£ç¢ºç´¢å¼•ã€‚\n\n';
                comment += '**ä¿®å¾©å»ºè­°ï¼š**\n';
                comment += '```bash\n';
                comment += 'npm run index:check\n';
                comment += 'npm run index:update\n';
                comment += '```\n\n';
              } else {
                comment += '### âœ… ç´¢å¼•ç‹€æ…‹è‰¯å¥½\n';
                comment += 'æ‰€æœ‰æ–‡ä»¶éƒ½å·²æ­£ç¢ºç´¢å¼•ã€‚\n\n';
              }

              if (report.suggestions?.length > 0) {
                comment += '### ğŸ’¡ æ”¹é€²å»ºè­°\n';
                const suggestions = report.suggestions.slice(0, 5);
                suggestions.forEach(s => {
                  comment += `- ${s.message}\n`;
                });

                if (report.suggestions.length > 5) {
                  comment += `- ... é‚„æœ‰ ${report.suggestions.length - 5} å€‹å»ºè­°\n`;
                }
              }

            } else {
              comment += 'âš ï¸ ç„¡æ³•è®€å–è©³ç´°å ±å‘Šæ–‡ä»¶ã€‚\n';
            }

          } catch (error) {
            comment += `âŒ è™•ç†å ±å‘Šæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}\n`;
          }

          comment += '\n---\n';
          comment += '*ğŸ¤– æ­¤å ±å‘Šç”± GitHub Actions è‡ªå‹•ç”Ÿæˆ*';

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: âŒ Fail if critical issues found
      if: steps.index_check.outputs.check_failed == 'true'
      run: |
        echo "âŒ ç´¢å¼•åŒæ­¥æª¢æŸ¥ç™¼ç¾åš´é‡å•é¡Œï¼"
        echo "è«‹ä¿®å¾©ç´¢å¼•å•é¡Œå¾Œå†æäº¤ã€‚"
        exit 1

  # æ¯æ—¥å ±å‘Šå·¥ä½œ
  daily-report:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci --legacy-peer-deps

    - name: ğŸ“Š Generate daily report
      run: |
        echo "ç”Ÿæˆæ¯æ—¥ç´¢å¼•å¥åº·å ±å‘Š..."
        node scripts/check-index-sync.js > daily_report.txt 2>&1
        node scripts/dev-reminder.js >> daily_report.txt 2>&1

    - name: ğŸ“§ Create issue for daily report
      if: contains(github.repository, 'ai-sales-enablement-webapp')
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const now = new Date();
          const dateStr = now.toISOString().split('T')[0];

          let reportContent = '## ğŸ“Š æ¯æ—¥ç´¢å¼•å¥åº·å ±å‘Š\n\n';
          reportContent += `**æ—¥æœŸ**: ${dateStr}\n`;
          reportContent += `**æª¢æŸ¥æ™‚é–“**: ${now.toISOString()}\n\n`;

          try {
            const report = fs.readFileSync('daily_report.txt', 'utf8');
            reportContent += '### æª¢æŸ¥çµæœ\n\n';
            reportContent += '```\n' + report + '\n```\n\n';
          } catch (error) {
            reportContent += 'âš ï¸ ç„¡æ³•è®€å–å ±å‘Šå…§å®¹ã€‚\n\n';
          }

          reportContent += '### ğŸ“‹ ç¶­è­·å»ºè­°\n\n';
          reportContent += '1. æª¢æŸ¥æ˜¯å¦æœ‰æ–°æ–‡ä»¶éœ€è¦åŠ å…¥ç´¢å¼•\n';
          reportContent += '2. ç¢ºèªç´¢å¼•æ–‡ä»¶è·¯å¾‘å¼•ç”¨æ­£ç¢º\n';
          reportContent += '3. æ¸…ç†éæœŸçš„ç´¢å¼•å¼•ç”¨\n\n';
          reportContent += '**å¿«é€Ÿä¿®å¾©å‘½ä»¤:**\n';
          reportContent += '```bash\n';
          reportContent += 'npm run index:check\n';
          reportContent += 'npm run index:update\n';
          reportContent += '```\n\n';
          reportContent += '---\n';
          reportContent += '*ğŸ¤– æ­¤å ±å‘Šç”± GitHub Actions æ¯æ—¥è‡ªå‹•ç”Ÿæˆ*';

          // å‰µå»º issue
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸ“Š æ¯æ—¥ç´¢å¼•å¥åº·å ±å‘Š - ${dateStr}`,
            body: reportContent,
            labels: ['ğŸ“‹ index-maintenance', 'ğŸ¤– automated']
          });

    - name: ğŸ“„ Upload daily report
      uses: actions/upload-artifact@v4
      with:
        name: daily-index-report
        path: daily_report.txt
        retention-days: 7